<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Bootstrap + Icons (same as your new design) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- ðŸ”¥ YOUR NEW DESIGN CSS (already exists) -->
<link rel="stylesheet" href="style.css">
</head>

<body>

<section class="message-area">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="chat-area">

          <!-- ================= USER LIST ================= -->
          <div class="chatlist">
            <div class="modal-content">
            <div class="chat-header">
                <div class="logo">
                  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="40" height="40">
                  <path d="M0 0 C13.2 0 26.4 0 40 0 C40 13.2 40 26.4 40 40 C26.8 40 13.6 40 0 40 C0 26.8 0 13.6 0 0 Z " fill="#FDFCFD" transform="translate(0,0)"></path>
                  <path d="M0 0 C1.74784467 -0.13560864 3.49873926 -0.23227209 5.25 -0.3125 C6.22453125 -0.37050781 7.1990625 -0.42851563 8.203125 -0.48828125 C11 0 11 0 13.08984375 2.0859375 C15.22274561 5.33981232 17.33857736 8.58507928 19.3125 11.9375 C19.8703418 12.82985352 19.8703418 12.82985352 20.43945312 13.74023438 C22.27470217 16.8673347 23.01691952 18.72386062 22.79296875 22.37890625 C22 25 22 25 21 26 C18.1875 26.375 18.1875 26.375 15 26 C10.91205662 21.73847091 8.17359535 16.40385306 5.25 11.3125 C4.74339844 10.44560547 4.23679687 9.57871094 3.71484375 8.68554688 C3.23660156 7.85732422 2.75835937 7.02910156 2.265625 6.17578125 C1.83024414 5.42208252 1.39486328 4.66838379 0.94628906 3.8918457 C0 2 0 2 0 0 Z " fill="#fb203b" transform="translate(3,8)"></path>
                  <path d="M0 0 C1.09054688 0.02320313 2.18109375 0.04640625 3.3046875 0.0703125 C4.40039062 0.08835937 5.49609375 0.10640625 6.625 0.125 C7.46804687 0.14820313 8.31109375 0.17140625 9.1796875 0.1953125 C8.36925914 1.67561522 7.55628402 3.15452392 6.7421875 4.6328125 C6.28972656 5.45652344 5.83726563 6.28023437 5.37109375 7.12890625 C4.1796875 9.1953125 4.1796875 9.1953125 3.1796875 10.1953125 C0.2421875 10.3828125 0.2421875 10.3828125 -2.8203125 10.1953125 C-4.8203125 8.1953125 -4.8203125 8.1953125 -5.0703125 5.1953125 C-4.73694203 1.1948668 -4.03804244 0.27964283 0 0 Z " fill="#1b99fe" transform="translate(29.8203125,7.8046875)"></path>
                  </svg>
                </div>
                <div class="msg-search">
                 <h5>Users</h5> 
                </div>
              </div>
              <div class="modal-body">
                <div class="chat-lists">
                  <div class="chat-list" id="userList">
                    <!-- USERS LOAD FROM FIREBASE -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ================= CHAT BOX ================= -->
          <div class="chatbox">
            <div class="modal-content">
              <span class="chat-icon">
                <i class="fa fa-arrow-left"></i>
              </span>
              <!-- HEADER -->
              <div class="msg-head">
                <div class="d-flex align-items-center">
                  
                  <img class="img-fluid" src="https://mehedihtml.com/chatbox/assets/img/user.png">
                  <div class="ms-3">
                    <h3 id="chatWith">Select a user</h3>
                  </div>

                </div>
                <button id="logoutBtn" style="background:none;border:none;color:#ff0000">
                   <i class="fas fa-sign-out-alt"></i>
                </button>
              </div>

              <!-- MESSAGES -->
              <div class="modal-body">
                <div class="msg-body">
                  <ul id="chatBox">
                    <!-- MESSAGES LOAD HERE -->
                  </ul>
                </div>
              </div>

              <!-- SEND BOX -->
              <div class="send-box">
                <form id="chatForm">
                  <input type="text" id="messageInput" class="form-control" placeholder="Write messageâ€¦" required>
                  <button type="submit">
                    <i class="fa fa-paper-plane"></i> Send
                  </button>
                </form>
              </div>

            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</section>

<!-- ================= FIREBASE ================= -->
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= CONFIG ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBpXv6AvjdLdsQxHUwZqJEqWvyQhWUZzUM",
  authDomain: "contactme-14cbd.firebaseapp.com",
  databaseURL: "https://contactme-14cbd-default-rtdb.firebaseio.com",
  projectId: "contactme-14cbd"
});

const auth = firebase.auth();
const db = firebase.database();

/* ================= STATE ================= */
let currentUser = null;
let chatRef = null;

/* ================= DOM ================= */
const userList = document.getElementById("userList");
const chatBox = document.getElementById("chatBox");
const chatWith = document.getElementById("chatWith");
const messageInput = document.getElementById("messageInput");

/* ================= AUTH ================= */
auth.onAuthStateChanged(user => {
  if (!user) location.href = "login.html";
  currentUser = user;
  saveUser(user);
  loadUsers();
});

/* ================= SAVE USER ================= */
function saveUser(user) {
  db.ref("users/" + user.uid).set({
    email: user.email
  });
}

/* ================= LOAD USERS ================= */
function loadUsers() {
  db.ref("users").on("value", snap => {
    userList.innerHTML = "";
    snap.forEach(child => {
      if (child.key !== currentUser.uid) {
        const a = document.createElement("a");
        a.href = "#";
        a.className = "d-flex align-items-center";
        a.innerHTML = `
          <div class="flex-shrink-0">
            
            <img class="img-fluid" src="https://mehedihtml.com/chatbox/assets/img/user.png">
          </div>
          <div class="flex-grow-1 ms-3">
            <h3>${child.val().email}</h3>
            <p>Click to chat</p>
          </div>
        `;
        a.onclick = () => openChat(child.key, child.val().email);
        userList.appendChild(a);
      }
    });
  });
}

/* ================= CHAT ID ================= */
function chatId(a, b) {
  return a < b ? a + "_" + b : b + "_" + a;
}

/* ================= OPEN CHAT ================= */
function openChat(uid, email) {
  chatWith.innerText = email;
  chatBox.innerHTML = "";

  if (chatRef) chatRef.off();

  chatRef = db.ref("chats/" + chatId(currentUser.uid, uid) + "/messages");

  chatRef.on("child_added", snap => {
    const msg = snap.val();
    const cls = msg.sender === currentUser.uid ? "repaly" : "sender";

    chatBox.insertAdjacentHTML(
      "beforeend",
      `<li class="${cls}">
         <p>${msg.text}</p>
         <span class="time">${new Date(msg.time).toLocaleTimeString()}</span>
       </li>`
    );

    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

/* ================= SEND MESSAGE ================= */
document.getElementById("chatForm").addEventListener("submit", e => {
  e.preventDefault();
  if (!chatRef) return alert("Select a user first");

  chatRef.push({
    sender: currentUser.uid,
    text: messageInput.value,
    time: Date.now()
  });

  messageInput.value = "";
});


jQuery(document).ready(function ($) {

  // OPEN CHAT
  $(document).on("click", ".chat-list a", function (e) {
    e.preventDefault();

    $(".chatbox").addClass("showbox");

    // Add browser history (for iPhone swipe back)
    history.pushState({ chatOpen: true }, "", "#chat");
  });

  // BACK BUTTON INSIDE CHAT (arrow)
  $(document).on("click", ".chat-icon", function () {
    closeChat();
    history.back(); // sync with browser history
  });

  // Handle iPhone swipe-back / browser back
  // window.onpopstate = function (event) {
  //   if ($(".chatbox").hasClass("showbox")) {
  //     closeChat();
  //   }
  // };

  function closeChat() {
    $(".chatbox").removeClass("showbox");
  }

});
logoutBtn.onclick=()=>auth.signOut();


</script>

</body>
</html>



